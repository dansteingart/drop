<html>
<head>
	<title>Wait For It</title>
    <script src="/static/jquery.min.js"></script>
    <script src="/static/dmuploader.min.js"></script>

	<style>
	body { font-family: Helvetica; font-size: 12px; width:900px; }
	table { font-family: Helvetica; font-size: 12px; }
	a {color:red;text-decoration:none;}
	h2 {color:gray;}

	a:hover{color:silver;}

	td { min-width:150px;}

	tr:nth-child(even) { background-color: #EEE;}

	.right{ float:right; width: 150px;}

	.main{width:750px;}


	</style>

</head>
<body>
	<h1 id="title">Wait For The Drop</h1>
	<h2 id="sub"></h2>
	<hr>
<div class="right">
	<div id="drop-area-div" >
  	  Drag / Drop Files Here
	</div>

	<div id="cur_upload"></div>
	<div id="queue_upload"></div>
</div>


<div class="main">
	<div id="test"> </div>
</div>
<script>

	foop = window.location.pathname.split("/").slice(1,-1)
	lanks = ""
	out = "/"
	for (f in foop) 
	{
			out+=foop[f]+"/"
			lanks += "<a href='"+out+"'>"+unescape(foop[f])+"</a>/"
	}  
	$("#sub").html("you are in "+lanks)

	//http://stackoverflow.com/a/8175221/565514
	function sortByKey(array, key) {
    	return array.sort(function(a, b) {
        	var x = a[key]; var y = b[key];
        	return ((x < y) ? -1 : ((x > y) ? 1 : 0));
    });}

	function csv_to_table(str)
	{
		out = "<table>\n"
		p = str.split("\n")
		for (i in p)
		{
			out+="<tr>"
			ii = p[i].split("||||")

			for (j in ii)
			{
				out += "<td>"+ii[j]+"</td>"
			}
			out+="</tr>\n"
		}
		out += "</table>"
		return out

	}

	function sizer(nums)
	{
		if (nums > 1e9) 		nums = Math.round(nums/1e7)/100 + " G"
		else if (nums > 1e6)	nums = Math.round(nums/1e4)/100 + " M"
		else if (nums > 1e3)	nums = Math.round(nums/1e1)/100 + " K"
		else nums = 			nums + " B"
		return nums

	}

	function linker(str)
	{
		nice = str.split("/")[str.split("/").length-1]
		str = str.replace("/filez/","/")
		return "<a href='"+str+"'>"+nice+"</a>"
	}


	inspector = null

	function getDir()
	{
	toget = window.location.pathname.slice(1)
	search = {'search':toget}
	out = ""
	$.post("/list/",search,function(data) {
		data = sortByKey(data,'mtime')
		data.reverse()
		for (d in data)
		{
			inspector = data
			nameo = linker(data[d]['name'])
			if (data[d]['is_dir']) nameo+="/"
			mtime = data[d]['mtime']
			size  = sizer(data[d]['size'])
			doop =nameo+"||||"+size +"||||"+mtime+"\n"
			console.log(doop)
			out += doop
		}
		$("#test").html(csv_to_table(out.trim()))

	})
	}


	getDir()

	//Upload Status Functions

	//Show Percent
	function uploadStatus(strang){$("#cur_upload").html(strang)}

	//Queue
	qq = {} //what's next
	going = null; //what's now
	function queueStatus(){
		out = ""
		for (q in qq) 		out += qq[q].name+":"+qq[q].size+";<br>"
		$("#queue_upload").html(out)
	}

	$("#drop-area-div").dmUploader(
		{
			url:'/upload/',
			extraData:{path:window.location.pathname},
			dataType: 'json',
			onNewFile: function(id, file){qq[id]=file},
			onBeforeUpload: function(id){going = qq[id];delete(qq[id]); queueStatus()},
	        onUploadSuccess: function(id,data){getDir();uploadStatus("")},
			onUploadProgress: function(id, percent){uploadStatus(going.name+": "+percent+"%")}
		}
	);

	setInterval(function(){getDir()},10000)

</script>

</body>



</html>
